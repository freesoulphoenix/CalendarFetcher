/* Calendar Fetcher - Host (Illustrator ExtendScript) */
/* Receives year + holidays/settings as STRINGS (JSON from CEP), parses via eval,
   then draws a 2x6 year layout on the active document. */

function CalendarFetcher_generateYear(year, holidaysStr, settingsStr) {
  try {
    // ---- Parse payload (ExtendScript sometimes lacks JSON) ----
    var holidays = eval("(" + holidaysStr + ")");
    var s = eval("(" + settingsStr + ")");

    // ---- Helpers: numeric coercion ----
    function num(v, fallback) {
      var n = Number(v);
      return isFinite(n) ? n : fallback;
    }
    function numRGB(arr, fallbackArr) {
      arr = arr || fallbackArr;
      return [
        num(arr[0], fallbackArr[0]),
        num(arr[1], fallbackArr[1]),
        num(arr[2], fallbackArr[2])
      ];
    }

    // ---- Normalize settings with safe defaults ----
    s = s || {};
    s.startX = num(s.startX, 60);
    s.startY = num(s.startY, 780);
    s.cellW  = num(s.cellW, 75);
    s.cellH  = num(s.cellH, 55);
    s.headerH = num(s.headerH, 40);
    s.weekStartsOn = num(s.weekStartsOn, 0);

    s.fontName = s.fontName || "ArialMT";
    s.fontSizeDay = num(s.fontSizeDay, 16);
    s.fontSizeHeader = num(s.fontSizeHeader, 28);
    s.fontSizeWeekday = num(s.fontSizeWeekday, 14);
    s.fontSizeLegend = num(s.fontSizeLegend, 12);

    s.colorHoliday = numRGB(s.colorHoliday, [220, 20, 60]);
    s.colorNormal  = numRGB(s.colorNormal,  [20, 20, 20]);
    s.colorGrid    = numRGB(s.colorGrid,    [70, 70, 70]);

    // Layout controls (2x6)
    s.monthCols = num(s.monthCols, 2);
    s.monthRows = num(s.monthRows, 6);
    s.monthGapX = num(s.monthGapX, 50);
    s.monthGapY = num(s.monthGapY, 70);

    // Legend box height inside each month block
    s.legendH = num(s.legendH, 60);

    // Size of one month "block"
    // Title area + weekday row area + grid + legend area
    s.blockW = num(s.blockW, s.cellW * 7);
    s.blockH = num(s.blockH, (s.headerH + (s.cellH * 6) + s.legendH + 30));

    // ---- Validate document ----
    if (!app.documents.length) {
      return "No document open. Create/open a document first.";
    }
    var doc = app.activeDocument;

    // ---- Build holiday lookup: YYYY-MM-DD -> [names...] ----
    var holMap = {};
    for (var i = 0; i < holidays.length; i++) {
      var h = holidays[i];
      if (!h || !h.date) continue;
      holMap[h.date] = holMap[h.date] || [];
      holMap[h.date].push((h.localName || "") + (h.name ? " (" + h.name + ")" : ""));
    }

    // ---- Root layer ----
    var root = doc.layers.add();
    root.name = "Calendar " + year;

    // ---- Draw 12 months in 2x6 layout ----
    for (var m = 0; m < 12; m++) {
      var col = m % s.monthCols;
      var row = Math.floor(m / s.monthCols);

      var x = s.startX + col * (s.blockW + s.monthGapX);
      var y = s.startY - row * (s.blockH + s.monthGapY);

      // Each month in its own sublayer (nice for editing)
      var monthLayer = root.layers.add();
      monthLayer.name = pad2(m + 1) + " " + monthNames()[m];

      generateMonth(monthLayer, year, m, holMap, s, x, y);
    }

    return "Generated year " + year + " (2Ã—6 layout).";

  } catch (e) {
    return "Generate failed: " + e.toString();
  }
}

// -------------------------------------------------
// Month generator (draws one month block at x0,y0)
// -------------------------------------------------
function generateMonth(layer, year, monthIndex, holMap, s, x0, y0) {
  var drawGrid = (s.renderStyle === "grid");
  var mName = monthNames()[monthIndex];

  // Title
  var title = layer.textFrames.add();
  title.contents = mName + " " + year;
  title.left = x0;
  title.top = y0;
  setTextStyle(title, s.fontName, s.fontSizeHeader, rgb(s.colorNormal));

  // Weekday headers
  var weekdaysSun = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  var weekdaysMon = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  var week = (s.weekStartsOn === 1) ? weekdaysMon : weekdaysSun;

  // Place weekday row below title
  var weekTop = y0 - s.headerH;
  for (var c = 0; c < 7; c++) {
    var tf = layer.textFrames.add();
    tf.contents = week[c];
    tf.left = x0 + c * s.cellW + 6;
    tf.top = weekTop;
    setTextStyle(tf, s.fontName, s.fontSizeWeekday, rgb(s.colorNormal));
  }

  // Grid origin (top of first row of boxes)
  var gridTop = weekTop - 18; // spacing below weekday row

  // Draw grid: 7x6
  for (var r = 0; r < 6; r++) {
    for (var cc = 0; cc < 7; cc++) {
      var rect = layer.pathItems.rectangle(
        gridTop - (r * s.cellH),
        x0 + (cc * s.cellW),
        s.cellW,
        s.cellH
      );
      rect.stroked = true;
      rect.strokeWidth = 1;
      rect.strokeColor = rgb(s.colorGrid);
      rect.filled = false;
    }
  }

  // Dates
  var firstDow = dayOfWeek(year, monthIndex, 1); // 0=Sun..6=Sat
  if (s.weekStartsOn === 1) firstDow = (firstDow + 6) % 7; // Monday=0

  var dim = daysInMonth(year, monthIndex);

  // Build legend items ONLY (no names in cells)
  var legendItems = [];

  for (var d = 1; d <= dim; d++) {
    var pos = firstDow + (d - 1);
    var rr = Math.floor(pos / 7);
    var cc2 = pos % 7;

    var dateStr = formatDate(year, monthIndex + 1, d);
    var isHoliday = !!holMap[dateStr];

    // Day number
    var dayTf = layer.textFrames.add();
    dayTf.contents = "" + d;
    dayTf.left = x0 + cc2 * s.cellW + 6;
    dayTf.top = gridTop - rr * s.cellH - 6;
    setTextStyle(dayTf, s.fontName, s.fontSizeDay, rgb(isHoliday ? s.colorHoliday : s.colorNormal));

    if (isHoliday) {
      var names = holMap[dateStr].join(" / ");
      legendItems.push(formatLegendShort(dateStr, names));
    }
  }

  // Legend area (bottom of month block)
  var legendTop = gridTop - (6 * s.cellH) - 18;
  var legendLeft = x0;
  var legendW = s.blockW;
  var legendH = s.legendH;

  var legendText = legendItems.length ? legendItems.join("; ") : "";

  // Area text so it wraps within month width
  createAreaText(layer, legendLeft, legendTop, legendW, legendH,
    legendText ? legendText : ""); // keep empty if none
  // If you want "No holidays" text, replace "" with:
  // (legendText ? legendText : "No public holidays.")
}

// -------------------------------------------------
// Drawing helpers
// -------------------------------------------------
function createAreaText(layer, left, top, width, height, contents) {
  // Invisible rectangle for area text
  var box = layer.pathItems.rectangle(top, left, width, height);
  box.stroked = false;
  box.filled = false;

  var tf = layer.textFrames.areaText(box);
  tf.contents = contents;

  // Legend style: red
  try {
    tf.textRange.characterAttributes.textFont = app.textFonts.getByName("ArialMT");
  } catch (e) {}
  tf.textRange.characterAttributes.size = 12;
  tf.textRange.characterAttributes.fillColor = rgb([220, 20, 60]);
  return tf;
}

function setTextStyle(tf, fontName, fontSize, color) {
  try {
    tf.textRange.characterAttributes.textFont = app.textFonts.getByName(fontName);
  } catch (e) {}
  tf.textRange.characterAttributes.size = fontSize;
  tf.textRange.characterAttributes.fillColor = color;
}

function rgb(arr) {
  var c = new RGBColor();
  c.red = Number(arr[0]);
  c.green = Number(arr[1]);
  c.blue = Number(arr[2]);
  return c;
}

// -------------------------------------------------
// Calendar helpers
// -------------------------------------------------
function monthNames() {
  return ["January","February","March","April","May","June","July","August","September","October","November","December"];
}

function pad2(n) {
  return (n < 10 ? "0" : "") + n;
}

// 0=Sun..6=Sat
function dayOfWeek(y, m, d) {
  var dt = new Date(y, m, d);
  return dt.getDay();
}

function daysInMonth(y, m) {
  return new Date(y, m + 1, 0).getDate();
}

function formatDate(y, mm, dd) {
  var m2 = (mm < 10 ? "0" : "") + mm;
  var d2 = (dd < 10 ? "0" : "") + dd;
  return y + "-" + m2 + "-" + d2;
}

// "YYYY-MM-DD" + name -> "Apr 3 - Name"
function formatLegendShort(dateStr, names) {
  var parts = dateStr.split("-");
  var m = Number(parts[1]);
  var d = Number(parts[2]);
  var mShort = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return mShort[m - 1] + " " + d + " - " + names;
}
